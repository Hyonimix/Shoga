<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shoga's Test Room</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* CSS Reset & Style */
        :root {
            /* Light Mode Variables */
            --bg-color: #f0f2f5;
            --app-bg: #fff;
            --text-color: #333;
            --sub-text-color: #666;
            --header-bg: rgba(255, 255, 255, 0.95);
            --header-border: rgba(0, 0, 0, 0.05);
            --chat-bg: #bacee0;
            --input-area-bg: #fff;
            --input-bg: #f8f9fa;
            --input-border: #eee;
            --my-msg-bg: #fef01b;
            --my-msg-text: #3b1e1e;
            --other-msg-bg: #fff;
            --other-msg-text: #2c3e50;
            --time-text: #555;
            --system-msg-bg: rgba(0, 0, 0, 0.1);
            --system-msg-text: #555;
            --login-bg: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
            --login-box-bg: rgba(255, 255, 255, 0.95);

            /* AI Lina Styles - Light Mode (Enhanced Glow) */
            --lina-bubble-bg: linear-gradient(145deg, #fdfcff 0%, #f3efff 100%);
            --lina-bubble-text: #5b21b6;
            --lina-bubble-border: rgba(124, 58, 237, 0.25);
            --lina-shadow: 0 4px 15px rgba(139, 92, 246, 0.2), 0 0 15px rgba(139, 92, 246, 0.15);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                /* Dark Mode Variables */
                --bg-color: #121212;
                --app-bg: #1e1e1e;
                --text-color: #e0e0e0;
                --sub-text-color: #aaa;
                --header-bg: rgba(30, 30, 30, 0.95);
                --header-border: rgba(255, 255, 255, 0.1);
                --chat-bg: #070b14;
                --input-area-bg: #1e1e1e;
                --input-bg: #2c2c2c;
                --input-border: #444;
                --my-msg-bg: #9b7700;
                --my-msg-text: #ffffff;
                --other-msg-bg: #333;
                --other-msg-text: #ddd;
                --time-text: #888;
                --system-msg-bg: rgba(255, 255, 255, 0.1);
                --system-msg-text: #bbb;
                --login-bg: linear-gradient(135deg, #1a2a3a 0%, #2c3e50 100%);
                --login-box-bg: rgba(30, 30, 30, 0.95);

                /* AI Lina Styles - Dark Mode (Enhanced Glow & Depth) */
                --lina-bubble-bg: linear-gradient(145deg, #2e1065 0%, #1e1b4b 100%);
                --lina-bubble-text: #e9d5ff;
                --lina-bubble-border: rgba(139, 92, 246, 0.5);
                --lina-shadow: 0 8px 25px rgba(0, 0, 0, 0.6), 0 0 20px rgba(139, 92, 246, 0.35);
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            height: 100vh;
            height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            color: var(--text-color);
        }

        .app-container {
            width: 100%;
            height: 100%;
            background: var(--app-bg);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        @media (min-width: 500px) {
            .app-container {
                max-width: 400px;
                height: 90vh;
                border-radius: 24px;
                border: 1px solid #e0e0e0;
            }
        }

        /* í™”ë©´ ê³µí†µ */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--app-bg);
            z-index: 10;
            transition: opacity 0.3s ease;
        }

        .hidden {
            display: none !important;
            opacity: 0;
        }

        /* 1. ë¡œê·¸ì¸(í‚¤ ì…ë ¥) í™”ë©´ */
        #login-screen {
            z-index: 20;
            justify-content: center;
            align-items: center;
            padding: 40px;
            background: var(--login-bg);
            overflow-y: auto;
        }

        .login-box {
            background: var(--login-box-bg);
            padding: 30px 20px;
            border-radius: 20px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .app-title {
            font-size: 24px;
            font-weight: 800;
            color: #333;
            margin-bottom: 4px;
        }

        @media (prefers-color-scheme: dark) {
            .app-title {
                color: #fff;
            }
        }

        .app-desc {
            font-size: 13px;
            color: var(--sub-text-color);
            margin-bottom: 14px;
        }

        .key-input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--input-border);
            border-radius: 12px;
            font-size: 14px;
            outline: none;
            transition: 0.2s;
            background: var(--input-bg);
            color: var(--text-color);
        }

        .key-input:focus {
            border-color: #4ca1af;
        }

        .btn-enter {
            width: 100%;
            background: #2c3e50;
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 14px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 5px;
        }

        .btn-enter:hover {
            background: #34495e;
            transform: translateY(-1px);
        }

        .btn-enter:active {
            transform: scale(0.98);
        }

        .qr-divider {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #888;
            margin: 10px 0;
        }

        .qr-divider::before,
        .qr-divider::after {
            content: "";
            flex: 1;
            height: 1px;
            background: #ddd;
            margin: 0 10px;
        }

        .qr-btn-group {
            display: flex;
            gap: 8px;
        }

        .btn-qr {
            flex: 1;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-color);
            padding: 10px;
            border-radius: 12px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: 0.2s;
        }

        #reader {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
            display: none;
        }

        #reader video {
            object-fit: cover;
            border-radius: 12px;
        }

        .btn-stop-scan {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 10px;
            cursor: pointer;
            display: none;
        }

        /* 2. ì±„íŒ… í™”ë©´ */
        #chat-screen {
            z-index: 10;
            background: var(--chat-bg);
        }

        .chat-header {
            height: 56px;
            background: var(--header-bg);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            border-bottom: 1px solid var(--header-border);
            color: var(--text-color);
        }

        .header-info {
            display: flex;
            flex-direction: column;
        }

        .room-name {
            font-weight: bold;
            font-size: 16px;
            color: var(--text-color);
        }

        .my-nick {
            font-size: 11px;
            color: #1a73e8;
        }

        .btn-logout {
            font-size: 12px;
            color: var(--sub-text-color);
            border: 1px solid var(--input-border);
            background: transparent;
            padding: 6px 12px;
            border-radius: 16px;
            cursor: pointer;
            transition: 0.2s;
        }

        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            scroll-behavior: auto;
        }

        .msg-row {
            display: flex;
            flex-direction: column;
            max-width: 75%;
            position: relative;
        }

        .msg-row.me {
            align-self: flex-end;
            align-items: flex-end;
        }

        .msg-row.other {
            align-self: flex-start;
            align-items: flex-start;
        }

        .sender-name {
            font-size: 11px;
            font-weight: 800;
            margin-bottom: 4px;
            margin-left: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            text-shadow:
                -1px -1px 0 var(--app-bg),
                1px -1px 0 var(--app-bg),
                -1px 1px 0 var(--app-bg),
                1px 1px 0 var(--app-bg);
        }

        .bubble-container {
            display: flex;
            align-items: flex-end;
            gap: 4px;
        }

        .msg-row.me .bubble-container {
            flex-direction: row-reverse;
        }

        .bubble {
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.5;
            word-break: break-all;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .msg-row.me .bubble {
            background: var(--my-msg-bg);
            color: var(--my-msg-text);
            border-top-right-radius: 4px;
        }

        .msg-row.other .bubble {
            background: var(--other-msg-bg);
            color: var(--other-msg-text);
            border-top-left-radius: 4px;
        }

        /* AI ë¦¬ë‚˜ ì „ìš© ìŠ¤íƒ€ì¼ ìˆ˜ì • (Enhanced Glow & Depth) */
        .msg-row.lina-msg .bubble {
            background: var(--lina-bubble-bg);
            color: var(--lina-bubble-text);
            border: 1px solid var(--lina-bubble-border);
            box-shadow: var(--lina-shadow);
            position: relative;
            animation: lina-entry 0.6s ease-out;
            overflow: hidden;
        }

        .msg-row.lina-msg .bubble::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(255, 255, 255, 0.4);
            pointer-events: none;
        }

        .badge-ai {
            background: #7c3aed;
            color: #fff;
            font-size: 8px;
            padding: 1px 5px;
            border-radius: 4px;
            font-weight: 800;
            text-shadow: none;
            letter-spacing: 0.5px;
            box-shadow: 0 1px 4px rgba(124, 58, 237, 0.3);
        }

        @keyframes lina-entry {
            from {
                opacity: 0;
                transform: translateY(12px) scale(0.96);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .msg-time {
            font-size: 10px;
            color: var(--time-text);
            min-width: 50px;
            margin-bottom: 2px;
        }

        .msg-row.me .msg-time {
            text-align: right;
        }

        .system-msg {
            align-self: center;
            background: var(--system-msg-bg);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            color: var(--system-msg-text);
            margin: 10px 0;
        }

        .input-area {
            background: var(--input-area-bg);
            padding: 12px;
            display: flex;
            gap: 8px;
            border-top: 1px solid var(--header-border);
        }

        #msg-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--input-border);
            border-radius: 24px;
            outline: none;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 15px;
        }

        #send-btn {
            background: #fef01b;
            border: none;
            width: 46px;
            height: 46px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #3b1e1e;
            font-size: 18px;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        #new-msg-alert {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 50;
            display: flex;
            align-items: center;
            gap: 5px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        #new-msg-alert.show {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>

<body>

    <div class="app-container">
        <div id="login-screen" class="screen">
            <div class="login-box">
                <div class="app-title">ğŸ”’ Shoga's Test Room</div>
                <div class="app-desc">ì´ˆëŒ€ë°›ì€ ë¶„ë§Œ ì…ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>

                <input type="text" id="nickname-input" class="key-input" placeholder="ë‹‰ë„¤ì„ (ë¯¸ì…ë ¥ ì‹œ ëœë¤)" maxlength="20"
                    style="margin-bottom: 8px;">

                <input type="password" id="api-key-input" class="key-input" placeholder="ë³´ì•ˆ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                <button class="btn-enter" onclick="handleKeyLogin()">ì…ì¥í•˜ê¸°</button>

                <div class="qr-divider">ë˜ëŠ” QR ì½”ë“œë¡œ ì…ë ¥</div>
                <div class="qr-btn-group">
                    <button class="btn-qr" onclick="startQrScan()">ğŸ“· ì¹´ë©”ë¼</button>
                    <button class="btn-qr" onclick="document.getElementById('qr-input-file').click()">ğŸ–¼ï¸ ì•¨ë²”</button>
                </div>

                <div id="reader"></div>
                <button id="btn-stop-scan" class="btn-stop-scan" onclick="stopQrScan()">ìŠ¤ìº” ì·¨ì†Œ</button>

                <input type="file" id="qr-input-file" accept="image/*" hidden onchange="scanFromFile(this)">
                <p id="error-msg" style="color: #e74c3c; font-size: 12px; margin-top: 10px;"></p>
            </div>
        </div>

        <div id="chat-screen" class="screen hidden">
            <div class="chat-header">
                <div class="header-info">
                    <span class="room-name">Laboratory</span>
                    <span class="my-nick" id="my-nick-display">...</span>
                </div>
                <button class="btn-logout" onclick="handleLogout()">ë‚˜ê°€ê¸°</button>
            </div>

            <div id="chat-area" class="chat-area"></div>

            <div id="new-msg-alert" onclick="scrollToBottom()">
                <span>â¬‡ï¸ ìƒˆ ë©”ì‹œì§€</span>
            </div>

            <div class="input-area">
                <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                    onkeypress="if(event.key==='Enter') sendMessage()">
                <button id="send-btn">â¤</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const baseConfig = {
            authDomain: "shoga-intermediary.firebaseapp.com",
            projectId: "shoga-intermediary",
            storageBucket: "shoga-intermediary.firebasestorage.app",
            messagingSenderId: "696629323825",
            appId: "1:696629323825:web:fede1b0d1dd1695afccd10",
            measurementId: "G-E4L52Z0HRE"
        };

        const GLOBAL_ROOM_ID = "Laboratory";
        let app, db, auth, user;
        let myNick = "";
        let isChatLoaded = false;
        let isInitialLoad = true;

        window.addEventListener('DOMContentLoaded', () => {
            const savedNick = localStorage.getItem('shoga_user_nick');
            if (savedNick) {
                document.getElementById('nickname-input').value = savedNick;
            }
            setupSendButton();
            setupScrollListener();
        });

        function setupSendButton() {
            const btn = document.getElementById('send-btn');
            const handleSend = (e) => {
                e.preventDefault();
                sendMessage();
            };
            btn.addEventListener('mousedown', handleSend);
            btn.addEventListener('touchstart', handleSend);
        }

        function setupScrollListener() {
            const chatArea = document.getElementById('chat-area');
            const alertBadge = document.getElementById('new-msg-alert');

            chatArea.addEventListener('scroll', () => {
                const threshold = 50;
                const isBottom = chatArea.scrollHeight - chatArea.scrollTop - chatArea.clientHeight <= threshold;
                if (isBottom) {
                    alertBadge.classList.remove('show');
                }
            });
        }

        window.scrollToBottom = () => {
            const chatArea = document.getElementById('chat-area');
            chatArea.scrollTop = chatArea.scrollHeight;
            document.getElementById('new-msg-alert').classList.remove('show');
        };

        const verbs = [
            "ì¶¤ì¶”ëŠ”", "ë‚ ì•„ë‹¤ë‹ˆëŠ”", "ì½”ë”©í•˜ëŠ”", "ë…¸ë˜í•˜ëŠ”", "ì ìëŠ”", "ë¼ë©´ë¨¹ëŠ”", "ë‹¬ë¦¬ëŠ”", "ë©ë•Œë¦¬ëŠ”", "ìˆ˜ì˜í•˜ëŠ”", "ì±…ì½ëŠ”",
            "ê²Œì„í•˜ëŠ”", "ì²­ì†Œí•˜ëŠ”", "ìš”ë¦¬í•˜ëŠ”", "ì—¬í–‰í•˜ëŠ”", "ê¿ˆê¾¸ëŠ”", "ê¸°ë„í•˜ëŠ”", "ìš´ë™í•˜ëŠ”", "ì‚°ì±…í•˜ëŠ”", "ìš´ì „í•˜ëŠ”", "ê³µë¶€í•˜ëŠ”",
            "ë¹„íŠ¸íƒ€ëŠ”", "ê·¸ë¦¼ê·¸ë¦¬ëŠ”", "ì†Œë¦¬ì§€ë¥´ëŠ”", "ì†ì‚­ì´ëŠ”", "ìˆ¨ì–´ìˆëŠ”", "ì•¼ê·¼í•˜ëŠ”", "ì¶œê·¼í•˜ëŠ”", "í‡´ê·¼í•˜ëŠ”", "ì‚¬ë‘í•˜ëŠ”", "ë¯¸ì›Œí•˜ëŠ”",
            "ìƒê°í•˜ëŠ”", "ë‚šì‹œí•˜ëŠ”", "ë“±ì‚°í•˜ëŠ”", "ì‡¼í•‘í•˜ëŠ”", "ì»¤í”¼ë§ˆì‹œëŠ”", "ì¹˜í‚¨ë¨¹ëŠ”", "í”¼ìë¨¹ëŠ”", "ë¬¼ë§ˆì‹œëŠ”", "ì „í™”í•˜ëŠ”", "ì¹´í†¡í•˜ëŠ”",
            "ìœ íŠœë¸Œë³´ëŠ”", "ë„·í”Œë³´ëŠ”", "ì¸ìŠ¤íƒ€í•˜ëŠ”", "íŠ¸ìœ—í•˜ëŠ”", "ëˆˆë¬¼í˜ë¦¬ëŠ”", "ì›ƒê³ ìˆëŠ”", "í™”ë‚´ê³ ìˆëŠ”", "ì‚ì ¸ìˆëŠ”", "ë‹¬ë‚˜ë¼ê°€ëŠ”", "ìš°ì£¼ê°€ëŠ”",
            "ë•…íŒŒëŠ”", "ì§‘ì§“ëŠ”", "ë¶€ìˆ˜ëŠ”", "ê³ ì¹˜ëŠ”", "ë„ë§ì¹˜ëŠ”", "ì«“ì•„ê°€ëŠ”", "ìˆ¨ì‰¬ëŠ”", "í•˜í’ˆí•˜ëŠ”", "ê¸°ì§€ê°œì¼œëŠ”", "ì„¸ìˆ˜í•˜ëŠ”",
            "ìƒ¤ì›Œí•˜ëŠ”", "ëª©ìš•í•˜ëŠ”", "ì–‘ì¹˜í•˜ëŠ”", "ë¨¸ë¦¬ê°ëŠ”", "í™”ì¥í•˜ëŠ”", "ë©´ë„í•˜ëŠ”", "ì˜·ì…ëŠ”", "ì‹ ë°œì‹ ëŠ”", "ì•ˆê²½ì“´", "ëª¨ìì“´",
            "ë§ˆìŠ¤í¬ì“´", "ê°€ë°©ë©˜", "ìš°ì‚°ì“´", "ìì „ê±°íƒ€ëŠ”", "ë²„ìŠ¤íƒ„", "ì§€í•˜ì² íƒ„", "ë¹„í–‰ê¸°íƒ„", "ë°°íƒ„", "ë¡œì¼“íƒ„", "ìš°ì£¼ì„ íƒ„",
            "í—¤ì—„ì¹˜ëŠ”", "ë‹¤ì´ë¹™í•˜ëŠ”", "ì„œí•‘í•˜ëŠ”", "ìŠ¤í‚¤íƒ€ëŠ”", "ë³´ë“œíƒ€ëŠ”", "ìŠ¤ì¼€ì´íŠ¸íƒ€ëŠ”", "ì¶•êµ¬í•˜ëŠ”", "ë†êµ¬í•˜ëŠ”", "ì•¼êµ¬í•˜ëŠ”", "ë°°êµ¬í•˜ëŠ”",
            "í”¼êµ¬í•˜ëŠ”", "ì¡±êµ¬í•˜ëŠ”", "íƒêµ¬í•˜ëŠ”", "í…Œë‹ˆìŠ¤ì¹˜ëŠ”", "ê³¨í”„ì¹˜ëŠ”", "ë³¼ë§ì¹˜ëŠ”", "ë‹¹êµ¬ì¹˜ëŠ”", "í¬ì¼“ë³¼ì¹˜ëŠ”", "ì²´ìŠ¤ë‘ëŠ”", "ë°”ë‘‘ë‘ëŠ”",
            "ì¥ê¸°ë‘ëŠ”", "ì˜¤ëª©ë‘ëŠ”", "ê³ ìŠ¤í†±ì¹˜ëŠ”", "í¬ì»¤ì¹˜ëŠ”", "ë§ˆìˆ í•˜ëŠ”", "ì—°ê¸°í•˜ëŠ”", "ë…¸ë˜ë¶€ë¥´ëŠ”", "ë©í•˜ëŠ”", "ë””ì œì‰í•˜ëŠ”", "ë“œëŸ¼ì¹˜ëŠ”",
            "ê¸°íƒ€ì¹˜ëŠ”", "í”¼ì•„ë…¸ì¹˜ëŠ”", "ë°”ì´ì˜¬ë¦°ì¼œëŠ”", "í”Œë£»ë¶€ëŠ”", "íŠ¸ëŸ¼í«ë¶€ëŠ”", "ì§€íœ˜í•˜ëŠ”", "ë°•ìˆ˜ì¹˜ëŠ”", "ì‘ì›í•˜ëŠ”", "êµ¬ê²½í•˜ëŠ”", "ì´¬ì˜í•˜ëŠ”",
            "ë…¹ìŒí•˜ëŠ”", "ë°©ì†¡í•˜ëŠ”", "ìŠ¤íŠ¸ë¦¬ë°í•˜ëŠ”", "ì±„êµ´í•˜ëŠ”", "íˆ¬ìí•˜ëŠ”", "ì €ì¶•í•˜ëŠ”", "ì†Œë¹„í•˜ëŠ”", "ê¸°ë¶€í•˜ëŠ”", "ë´‰ì‚¬í•˜ëŠ”", "ì¹˜ë£Œí•˜ëŠ”", "ê°œë°œí•˜ëŠ”"
        ];

        const adjectives = [
            "í–‰ë³µí•œ", "ìŠ¬í”ˆ", "ë°°ê³ í”ˆ", "ì‹œí¬í•œ", "ì†Œì‹¬í•œ", "ìš©ê°í•œ", "ë˜‘ë˜‘í•œ", "ìˆ˜ìƒí•œ", "ê·€ì—¬ìš´", "ë¬´ì„œìš´",
            "í™”ë ¤í•œ", "íˆ¬ëª…í•œ", "ê°•ë ¥í•œ", "ê²Œìœ¼ë¥¸", "ë¶€ì§€ëŸ°í•œ", "ì¡°ìš©í•œ", "ì‹œë„ëŸ¬ìš´", "ìš°ì•„í•œ", "ì—‰ëš±í•œ", "ì„¹ì‹œí•œ",
            "ì§„ì§€í•œ", "ìœ ì¾Œí•œ", "ëƒ‰ì •í•œ", "ë”°ëœ»í•œ", "ì¹œì ˆí•œ", "ë¶ˆì¹œì ˆí•œ", "ê°€ë‚œí•œ", "ë¶€ìœ í•œ", "ê±´ê°•í•œ", "ì•„í”ˆ",
            "í”¼ê³¤í•œ", "ìƒì¾Œí•œ", "ì§€ë£¨í•œ", "ì¬ë¯¸ìˆëŠ”", "ì‹ ë¹„ë¡œìš´", "í‰ë²”í•œ", "íŠ¹ë³„í•œ", "ì´ìƒí•œ", "ë¯¸ì¹œ", "ì œì •ì‹ ì¸",
            "ìˆœìˆ˜í•œ", "íƒ€ë½í•œ", "ê²€ì€", "í•˜ì–€", "ë¹¨ê°„", "íŒŒë€", "ë…¸ë€", "ì´ˆë¡", "ë³´ë¼", "ë¶„í™",
            "í™©ê¸ˆ", "ì€ë¹›", "ë¬´ì§€ê°œ", "ë¹›ë‚˜ëŠ”", "ì–´ë‘ìš´", "íë¦¿í•œ", "ì„ ëª…í•œ", "ê±°ëŒ€í•œ", "ì¡°ê·¸ë§Œ", "ê¸¸ì­‰í•œ",
            "ëš±ëš±í•œ", "ë‚ ì”¬í•œ", "í†µí†µí•œ", "ë§ˆë¥¸", "ê·¼ìœ¡ì§ˆì˜", "ë§ë‘í•œ", "ë”±ë”±í•œ", "ë¶€ë“œëŸ¬ìš´", "ê±°ì¹œ", "ë§¤ë„ëŸ¬ìš´",
            "ì°¨ê°€ìš´", "ëœ¨ê±°ìš´", "ë¯¸ì§€ê·¼í•œ", "ë§¤ìš´", "ë‹¬ì½¤í•œ", "ì“´", "ì‹ ", "ì§ ", "ì‹±ê±°ìš´", "ê³ ì†Œí•œ",
            "ëŠë¼í•œ", "ë‹´ë°±í•œ", "ë¹„ì‹¼", "ì‹¼", "ìƒˆë¡œìš´", "ì˜¤ë˜ëœ", "ë¹ˆí‹°ì§€", "ëª¨ë˜í•œ", "í´ë˜ì‹í•œ", "í™í•œ",
            "ì¸ì‹¸", "ì•„ì‹¸", "ì²œì¬", "ë°”ë³´", "ê³ ìˆ˜", "ì¤‘ìˆ˜", "í•˜ìˆ˜", "ì´ˆë³´", "ë§Œë ™", "ë‰´ë¹„",
            "ì „ì„¤ì˜", "í™˜ìƒì˜", "ìµœê³ ì˜", "ìµœì•…ì˜", "ë¬´ì ì˜", "ìœ ì¼í•œ", "í”í•œ", "í¬ê·€í•œ", "ë©¸ì¢…ìœ„ê¸°", "ì‚´ì•„ë‚¨ì€",
            "ì£½ì§€ì•ŠëŠ”", "ì˜ì›í•œ", "ì¼ì‹œì ì¸", "ê°€ì§œ", "ì§„ì§œ", "ì›ì¡°", "ì§í‰", "êµ­ì‚°", "ìˆ˜ì…", "ì™¸ê³„",
            "ì§€ì˜¥ì—ì„œì˜¨", "ì²œêµ­ì—ì„œì˜¨", "ë¯¸ë˜ì—ì„œì˜¨", "ê³¼ê±°ì—ì„œì˜¨", "ì´ì„¸ê³„", "ì €ì„¸ìƒ", "í‚¹ë°›ëŠ”", "ì•¼ë¬´ì§„", "ì—„ì²­ë‚œ", "ëŒ€ë‹¨í•œ"
        ];

        const animals = [
            "í˜¸ë‘ì´", "ì‚¬ì", "í† ë¼", "ë‹¤ëŒì¥", "í­ê·„", "ê³ ì–‘ì´", "ê°•ì•„ì§€", "ì¿¼ì¹´", "ì•ŒíŒŒì¹´", "ì˜¤ë¦¬",
            "ë…ìˆ˜ë¦¬", "ê±°ë¶ì´", "íŒë‹¤", "ë„ˆêµ¬ë¦¬", "ì—¬ìš°", "ê³°ëŒì´", "ëŒê³ ë˜", "ë¶€ì—‰ì´", "ê¸°ë¦°", "ì½”ë¼ë¦¬",
            "í–„ìŠ¤í„°", "ì•µë¬´ìƒˆ", "ìˆ˜ë‹¬", "í•˜ë§ˆ", "ë¯¸ì–´ìº£", "ì¹˜íƒ€", "í‘œë²”", "ì¬ê·œì–´", "í“¨ë§ˆ", "í•˜ì´ì—ë‚˜",
            "ëŠ‘ëŒ€", "ì½”ìš”í…Œ", "ë“¤ê°œ", "ë°˜ë‹¬ê³°", "ë¶ê·¹ê³°", "ë¶ˆê³°", "íŒ¬ë”", "ë˜ì„œíŒ¬ë”", "ë‚˜ë¬´ëŠ˜ë³´", "ë‘ë”ì§€",
            "ê³ ìŠ´ë„ì¹˜", "ë°•ì¥", "ìº¥ê±°ë£¨", "ì½”ì•Œë¼", "ì›œë±ƒ", "ì˜¤ë¦¬ë„ˆêµ¬ë¦¬", "íƒ€ì¡°", "ê³µì‘", "í•™", "ë‘ë£¨ë¯¸",
            "ë°±ì¡°", "ê±°ìœ„", "ë‹­", "ë³‘ì•„ë¦¬", "ë¹„ë‘˜ê¸°", "ê¹Œì¹˜", "ê¹Œë§ˆê·€", "ì°¸ìƒˆ", "ì œë¹„", "ê°ˆë§¤ê¸°",
            "í ë¦¬ì»¨", "í™í•™", "ì•…ì–´", "ë„ë§ˆë±€", "ì¹´ë©œë ˆì˜¨", "ì´êµ¬ì•„ë‚˜", "ë±€", "êµ¬ë ì´", "ê°œêµ¬ë¦¬", "ë‘êº¼ë¹„",
            "ë„ë£¡ë‡½", "ìƒì–´", "ê³ ë˜", "ë²”ê³ ë˜", "ë¬¼ê°œ", "ë°”ë‹¤í‘œë²”", "ë°”ë‹¤ì½”ë¼ë¦¬", "ë§¤ë„ˆí‹°", "ë“€ê³µ", "ê°€ì˜¤ë¦¬",
            "ì˜¤ì§•ì–´", "ë¬¸ì–´", "ë‚™ì§€", "ì­ˆê¾¸ë¯¸", "ê²Œ", "ê°€ì¬", "ìƒˆìš°", "ëìŠ¤í„°", "ì¡°ê°œ", "ì†Œë¼",
            "í•´íŒŒë¦¬", "ë¶ˆê°€ì‚¬ë¦¬", "ì„±ê²Œ", "í•´ë§ˆ", "ê¸ˆë¶•ì–´", "ì‰ì–´", "ì†¡ì–´", "ì—°ì–´", "ì°¸ì¹˜", "ê³ ë“±ì–´",
            "í‹°ë¼ë…¸", "íŠ¸ë¦¬ì¼€ë¼", "ë²¨ë¡œì‹œ", "ë¸Œë¼í‚¤ì˜¤", "ìš©", "ë“œë˜ê³¤", "ìœ ë‹ˆì½˜", "í˜ê°€ìˆ˜ìŠ¤", "í”¼ë‹‰ìŠ¤", "í•´íƒœ",
            "ì‚¬ëŒ", "ì™¸ê³„ì¸", "ë¡œë´‡", "ì•ˆë“œë¡œì´ë“œ", "ì‚¬ì´ë³´ê·¸", "ìœ ë ¹", "ì¢€ë¹„", "ìŠ¤ì¼ˆë ˆí†¤", "ìŠ¬ë¼ì„", "ê³ ë¸”ë¦°",
            "ì˜¤í¬", "ì—˜í”„", "ë“œì›Œí”„", "ì²œì‚¬", "ì•…ë§ˆ", "ì‹ ", "ì™•", "ì—¬ì™•", "ì™•ì", "ê³µì£¼", "ê°œë°œì"
        ];

        // ë‹‰ë„¤ì„ ìƒì„± ë¡œì§ (ê³µë°±ì„ ì–¸ë”ë°”ë¡œ ë³€ê²½, # ì œê±°)
        function generateRandomNick() {
            const v = verbs[Math.floor(Math.random() * verbs.length)];
            const a = adjectives[Math.floor(Math.random() * adjectives.length)];
            const n = animals[Math.floor(Math.random() * animals.length)];
            const tag = Math.floor(Math.random() * 9000) + 1000;
            return `${v}_${a}_${n}_${tag}`;
        }

        // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë‹‰ë„¤ì„ í‘œì‹œìš© í¬ë§·í„° (ê°œì„ ë¨)
        function formatDisplayNick(nick) {
            if (!nick) return "";
            // ì–¸ë”ë°”ë¥¼ ê³µë°±ìœ¼ë¡œ ì¹˜í™˜í•˜ê³ , 
            // ë§ˆì§€ë§‰ 4ìë¦¬ ìˆ«ì ì•ì— '#'ì´ ì—†ìœ¼ë©´ ë¶™ì—¬ì¤Œ (ì´ë¯¸ ìˆìœ¼ë©´ ì¤‘ë³µ ë°©ì§€)
            return nick.replace(/_/g, " ").replace(/#?(\d{4})$/, "#$1");
        }

        function getNickColor(nick) {
            let hash = 0;
            for (let i = 0; i < nick.length; i++) {
                hash = nick.charCodeAt(i) + ((hash << 5) - hash);
            }
            const h = Math.abs(hash) % 360;
            return `hsl(${h}, 65%, 45%)`;
        }

        window.handleKeyLogin = async () => {
            const inputKey = document.getElementById('api-key-input').value.trim();
            const inputNick = document.getElementById('nickname-input').value.trim();
            const errorMsg = document.getElementById('error-msg');

            if (!inputKey) {
                errorMsg.innerText = "ë³´ì•ˆ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                return;
            }

            try {
                const config = { ...baseConfig, apiKey: inputKey };
                if (getApps().length > 0) {
                    location.reload();
                    return;
                }
                app = initializeApp(config);
                auth = getAuth(app);
                db = getDatabase(app);
                await signInAnonymously(auth);
                user = auth.currentUser;

                if (inputNick) {
                    // ìˆ˜ë™ ì…ë ¥ ì‹œì—ë„ Firebase ê¸ˆì§€ ë¬¸ì ì²˜ë¦¬
                    myNick = inputNick.replace(/\s/g, '_').replace(/#/g, '');
                    localStorage.setItem('shoga_user_nick', inputNick);
                } else {
                    myNick = generateRandomNick();
                }
                showChatScreen();
            } catch (error) {
                console.error(error);
                let msg = "ì ‘ì† ì‹¤íŒ¨: ì˜¬ë°”ë¥´ì§€ ì•Šì€ í‚¤ì…ë‹ˆë‹¤.";
                if (error.code === 'auth/operation-not-allowed') {
                    msg = "ì„œë²„ ì„¤ì • ì˜¤ë¥˜: Firebase ì½˜ì†”ì—ì„œ 'ìµëª… ë¡œê·¸ì¸'ì„ ì¼œì£¼ì„¸ìš”.";
                }
                errorMsg.innerText = msg;
            }
        };

        window.handleLogout = () => {
            if (auth) {
                signOut(auth).then(() => {
                    location.reload();
                });
            } else {
                location.reload();
            }
        };

        function showChatScreen() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.remove('hidden');
            document.getElementById('my-nick-display').innerText = formatDisplayNick(myNick);
            stopQrScan();
            if (!isChatLoaded) {
                loadChat();
                isChatLoaded = true;
            }
        }

        function loadChat() {
            const chatArea = document.getElementById('chat-area');
            chatArea.innerHTML = `<div class="system-msg">ğŸ”“ ì¸ì¦ ì„±ê³µ! ë‹‰ë„¤ì„: [${formatDisplayNick(myNick)}]</div>`;
            const chatRef = ref(db, 'chats/' + GLOBAL_ROOM_ID);
            onChildAdded(chatRef, (snapshot) => {
                const data = snapshot.val();
                if (data) drawMessage(data);
            });
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            let hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
            hours = hours % 12;
            hours = hours ? hours : 12;
            const strMinutes = minutes < 10 ? '0' + minutes : minutes;
            return `${ampm} ${hours}:${strMinutes}`;
        }

        function drawMessage(data) {
            const chatArea = document.getElementById('chat-area');
            const alertBadge = document.getElementById('new-msg-alert');
            const isMe = user && (data.uid === user.uid);
            const isLina = data.nick === 'ë¦¬ë‚˜';

            const threshold = 50;
            const wasAtBottom = chatArea.scrollHeight - chatArea.scrollTop - chatArea.clientHeight <= threshold;

            const row = document.createElement('div');
            row.className = `msg-row ${isMe ? 'me' : 'other'} ${isLina ? 'lina-msg' : ''}`;

            const timeStr = data.time ? formatTime(data.time) : '';
            const nickColor = getNickColor(data.nick);

            let html = '';
            if (!isMe) {
                html += `<span class="sender-name" style="color: ${nickColor}">
                            ${escapeHtml(formatDisplayNick(data.nick))}
                            ${isLina ? '<span class="badge-ai">AI</span>' : ''}
                         </span>`;
            }

            html += `<div class="bubble-container">`;
            html += `  <div class="bubble">${escapeHtml(data.text)}</div>`;
            html += `  <span class="msg-time">${timeStr}</span>`;
            html += `</div>`;

            row.innerHTML = html;
            chatArea.appendChild(row);

            if (isInitialLoad) {
                chatArea.scrollTop = chatArea.scrollHeight;
                return;
            }

            if (isMe || wasAtBottom) {
                chatArea.scrollTop = chatArea.scrollHeight;
                alertBadge.classList.remove('show');
            } else {
                alertBadge.classList.add('show');
            }
        }

        setTimeout(() => {
            isInitialLoad = false;
        }, 2000);

        window.sendMessage = () => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text || !user) return;
            const chatRef = ref(db, 'chats/' + GLOBAL_ROOM_ID);
            push(chatRef, {
                uid: user.uid,
                nick: myNick,
                text: text,
                time: serverTimestamp()
            }).then(() => {
                input.value = '';
            }).catch(() => alert("ì „ì†¡ ì‹¤íŒ¨"));
        };

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        document.getElementById('api-key-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') window.handleKeyLogin();
        });

        document.getElementById('nickname-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('api-key-input').focus();
        });

    </script>

    <script>
        let html5QrcodeScanner = null;

        function startQrScan() {
            const readerDiv = document.getElementById('reader');
            const stopBtn = document.getElementById('btn-stop-scan');
            readerDiv.style.display = "block";
            stopBtn.style.display = "inline-block";
            html5QrcodeScanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
                .catch(err => {
                    alert("ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    stopQrScan();
                });
        }

        function scanFromFile(input) {
            if (input.files.length === 0) return;
            const imageFile = input.files[0];
            const html5QrCode = new Html5Qrcode("reader");
            html5QrCode.scanFile(imageFile, true)
                .then(onScanSuccess)
                .catch(err => {
                    alert("QR ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    input.value = '';
                });
        }

        function onScanSuccess(decodedText) {
            const keyInput = document.getElementById('api-key-input');
            keyInput.value = decodedText;
            stopQrScan();
            keyInput.focus();
        }

        function stopQrScan() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                }).catch(err => console.log(err));
            }
            document.getElementById('reader').style.display = "none";
            document.getElementById('btn-stop-scan').style.display = "none";
        }
    </script>
</body>

</html>
